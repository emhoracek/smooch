(()=>{function t(t,e){const s=t[0],n=t[1];return()=>{e.logger.debug(`Setting timer ${s} for ${n}ms`);const t=e.timers[s].timeout;t&&clearTimeout(t);const i=setTimeout((()=>{e.timers[s].timeout=!1,e.timers[s].callback()}),n);e.timers[s].timeout=i}}function e(t,e){const s=o(t[0],e);if(s)return s.map.bind(s)}function s(t,e){const s=o(t[0],e);if(s)return s.unmap.bind(s)}function n(t,e){const s=t[0].replace(".au",".wav"),n=document.getElementById(s.replace(".wav",""));return()=>n.play()}function i(t,e){const s=o(t[0],e);if(s)return s.altmap.bind(s)}function o(t,e){if("number"==typeof t){const s=e.getObject(t);if(s)return s;e.logger.warn(`Unable to find object with mark "#${t}"`)}if(t.endsWith(".cel")){const s=e.getCel(t);if(s)return s;e.logger.warn(`Unable to find cel with filename "${t}"`)}e.logger.error(`Expected a cel or object reference but got "${t}"`)}function r(o,r){const c=a[o.event];if(c){const a=o.actions.map((o=>function(o,r){const a={altmap:i,map:e,sound:n,timer:t,unmap:s}[o.action];if(a)return a(o.args,r);r.logger.warn(`Unknown action "${o.action}"`)}(o,r))).filter((t=>void 0!==t));c(o.args,a,r)}else r.logger.warn(`Unknown event "${o.event}"`)}const a={alarm:function(t,e,s){const n=t[0];s.timers[n]={timeout:!1,callback:()=>{e.forEach((t=>t())),s.update(),s.draw()}}},begin:function(t,e,s){s.addEventListener("begin",(t=>e.forEach((t=>t()))))},catch:function(t,e,s){o(t[0],s).addEventListener("catch",(t=>e.forEach((t=>t()))))},drop:function(t,e,s){o(t[0],s).addEventListener("drop",(t=>e.forEach((t=>t()))))},col:function(t,e,s){s.logger.warn("Not implemented: `col`. Smooch doesn't implement palette groups.")},end:function(t,e,s){s.logger.warn("Not implemented: `end`. The browser environment makes this event impractical.")},fixcatch:function(t,e,s){o(t[0],s).addEventListener("fixcatch",(t=>e.forEach((t=>t()))))},fixdrop:function(t,e,s){o(t[0],s).addEventListener("fixdrop",(t=>e.forEach((t=>t()))))},initialize:function(t,e,s){s.addEventListener("initialize",(t=>e.forEach((t=>t()))))},never:function(){},press:function(t,e,s){const n=o(t[0],s);n&&n.addEventListener("press",(t=>e.forEach((t=>{t&&t()}))))},release:function(t,e,s){o(t[0],s).addEventListener("release",(t=>e.forEach((t=>t()))))},set:function(t,e,s){const n=t[0];s.addEventListener(`set-${n}`,(t=>e.forEach((t=>t()))))},unfix:function(t,e,s){s.logger.warn("Not implemented: `unfix`. Smooch doesn't (currently) decrement fix.")}};const c=new CustomEvent("press");class h extends EventTarget{constructor(t,e,s,n){return super(),this.name=e.name,this.mark=e.mark,this.id=e.name,this.fix=e.fix,this.position=t.positions[0],this.positions=t.positions,this.sets=e.sets,this.image=document.getElementById(e.name+"-"+e.palette),this.ghostImage=void 0,this.visible=!1,this.mapped=!0,this.alpha=e.alpha,this.currentSet=0,this.offset=e.offset,this.init(s),this.ghostImage.onload=function(){n()},this}init(t){const e=t.ctxt,s=t.canvas,n=this.image;e.drawImage(n,0,0,n.width,n.height);const i=e.getImageData(0,0,n.width,n.height),o=i.data,r={red:(16711680&(a=this.mark))>>16,green:(65280&a)>>8,blue:255&a};var a;for(let t=0;t<o.length;t+=4)o[t]=r.red,o[t+1]=r.green,o[t+2]=r.blue;e.clearRect(0,0,t.size.x,t.size.y),e.putImageData(i,0,0),this.ghostImage=new Image,this.ghostImage.src=s.toDataURL("image/png"),e.clearRect(0,0,t.size.x,t.size.y)}update(t){this.currentSet=t,-1!==this.sets.indexOf(t)&&this.mapped?this.visible=!0:this.visible=!1,this.position=this.positions[t]}draw(t,e){!0===this.visible&&(this.alpha&&(t.globalAlpha=(255-this.alpha)/255),t.drawImage(this.image,this.position.x+this.offset.x,this.position.y+this.offset.y),t.globalAlpha=1,e.drawImage(this.ghostImage,this.position.x+this.offset.x,this.position.y+this.offset.y))}altmap(){this.mapped=!this.mapped}map(){this.mapped=!0}unmap(){this.mapped=!1}}class l extends EventTarget{constructor(t,e){return super(),this.mark=t,this.id=t,this.currentSet=0,this.positions=e,this.cels=[],this}update(t){this.currentSet=t;for(let e=0;e<this.cels.length;e++)this.cels[e].update(t)}get position(){return this.positions[this.currentSet]}get fixed(){return this.cels.some((t=>t.fix>0))}setPosition(t,e){this.positions[this.currentSet].x=t,this.positions[this.currentSet].y=e}altmap(){this.cels.forEach((t=>{t.altmap()}))}map(){this.cels.forEach((t=>t.map()))}unmap(){this.cels.forEach((t=>t.unmap()))}}class d{constructor(t){["debug","warning","error"].includes(t)?this.logLevel=t:this.logLevel="none"}debug(t){"none"!==this.logLevel&&console.log(t)}warn(t){"none"!==this.logLevel&&"debug"!==this.logLevel&&console.log(t)}error(t){"error"===this.logLevel&&console.log(t)}}class u extends EventTarget{constructor(t,e){super(),this.logger=new d("debug"),this.size={x:t.window_size[0],y:t.window_size[1]};document.getElementById("borderarea").style.background=t.border;const s=document.getElementById("playarea");return s.style.width=this.size.x+"px",s.style.height=this.size.y+"px",s.style.background=t.background,this.initCanvases(this.size),this.currentSet=0,this.objs=[],this.cels=[],this.timers=[],this.init(t.cels,t.positions,e),function(t){const e=document.getElementsByClassName("set");for(let s=0;s<e.length;s++)e[s].addEventListener("click",(function(){const e=parseInt(this.innerHTML);t.update(e),t.draw(),g(t.currentSet)}));const s=document.getElementsByClassName("tip")[0];document.getElementById("open-tip").addEventListener("click",(t=>{s.style.display="block"}));document.getElementById("close-tip").addEventListener("click",(t=>{s.style.display="none"}))}(this),this.initFKiSS(t.fkiss),this.dispatchEvent(new CustomEvent("initialize")),this.update(),this.draw(),this.dispatchEvent(new CustomEvent("begin")),this}init(t,e,s){t.reverse(),t.forEach((t=>{const n=this.objs[t.mark];if(n){const e=new h(n,t,this,s);n.cels.push(e),this.cels.push(e)}else{const n=new l(t.mark,e.map((e=>e.positions[t.mark]||{x:0,y:0}))),i=new h(n,t,this,s);n.cels.push(i),this.objs[t.mark]=n,this.cels.push(i)}}))}initCanvases(t){const e=document.getElementById("screen");m(e,t);const s=document.getElementById("ghost");m(s,t),this.canvas=e,this.ctxt=e.getContext("2d"),this.ghost=s.getContext("2d"),e.addEventListener("touchstart",(function(t){t.preventDefault()})),e.addEventListener("touchmove",(function(t){t.preventDefault()})),e.addEventListener("touchend",(function(t){t.preventDefault()})),e.addEventListener("touchcancel",(function(t){t.preventDefault()}))}getSelectedObject(t){const e=this.ghost.getImageData(t.x,t.y,1,1).data,s=(n=e[0],i=e[1],o=e[2],(n<<16)+(i<<8)+o);var n,i,o;if(0!==e[3]){return this.objs[s]}console.log("not draggable")}getObjectPosition(t){return t.positions[this.currentSet]}getCel(t){return this.cels.find((e=>e.name+".cel"===t))}getObject(t){return this.objs[t]}moveObject(t,e,s){t.setPosition(e,s),this.update(),this.draw()}initFKiSS(t){t.forEach((t=>{r(t,this)}))}update(t){void 0!==t&&(this.currentSet=t);for(let t=0;t<this.objs.length;t++)this.objs[t]&&this.objs[t].update(this.currentSet)}draw(){this.ctxt.clearRect(0,0,this.size.x,this.size.y),this.ghost.clearRect(0,0,this.size.x,this.size.y);for(let t=0;t<this.cels.length;t++)this.cels[t]&&this.cels[t].draw(this.ctxt,this.ghost)}}function g(t){const e=document.getElementsByClassName("set");for(let s=0;s<e.length;s++)t===parseInt(e[s].innerHTML)?e[s].style.color="black":e[s].style.color="grey"}function m(t,e){t.style.width=e.x+"px",t.style.height=e.y+"px",t.width=e.x,t.height=e.y}class p{constructor(t){this.dragHandler=!1,this.doll=t,this.screen=document.getElementById("screen");const e=document.getElementById("ghost");this.ctxt=e.getContext("2d")}initialize(){document.addEventListener("pointerdown",(t=>this.onMouseDown(t))),document.addEventListener("pointerup",(()=>{this.dragHandler&&(document.removeEventListener("pointermove",this.dragHandler),this.dragHandler=!1)}))}onMouseDown(t){const e=this.getMousePos(t),s=this.doll.getSelectedObject(e);if(s&&(s.dispatchEvent(c),s.cels.forEach((t=>{t.dispatchEvent(c)})),!s.fixed)){const n=this.getDragStart(s,e);this.dragHandler=t=>this.onMouseMove(t,s,n),document.addEventListener("pointermove",this.dragHandler),t.preventDefault()}}getDragStart(t,e){const s=this.doll.getObjectPosition(t);return{x:s.x-e.x,y:s.y-e.y}}onMouseMove(t,e,s){const n=this.getMousePos(t),i=s.x+n.x,o=s.y+n.y;this.doll.moveObject(e,i,o),t.preventDefault()}getMousePos(t){const e=this.screen.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}}window.addEventListener("load",(function(){let t=0;const e=kissJson.cels.length,s=new u(kissJson,(()=>{t+=1}));new p(s).initialize(),"undefined"!=typeof globalKiss&&(globalKiss=s),window.setTimeout((function s(){t<e&&(console.log(`loading ${t} of ${e}`),window.setTimeout(s,500))}),500)}))})();
//# sourceMappingURL=doll.js.map
